{% extends "base.html" %}
{% block title %}Seleccionar Mesa - Restaurante ABBA{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Seleccionar Mesa</h1>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for table in tables %}
        <div class="card p-6 relative {% if table.is_available %}bg-white{% else %}bg-red-50 border-red-200{% endif %}">
            <div class="absolute top-4 right-4">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" data-id="{{ table.id }}" {% if table.is_available %}checked{% endif %} onchange="toggleTable(event)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <a href="{% url 'menu' table.id %}" class="{% if not table.is_available %}pointer-events-none opacity-50{% endif %} block">
                <div class="text-center">
                    <i class="fas fa-utensils text-4xl text-blue-400 mb-4"></i>
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">Mesa {{ table.number }}</h2>
                    <p class="text-gray-600 mb-2">Capacidad: {{ table.capacity }}</p>
                    <p class="text-sm {% if table.is_available %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if table.is_available %}
                            <i class="fas fa-check-circle mr-1"></i>Disponible
                        {% else %}
                            <i class="fas fa-times-circle mr-1"></i>Ocupada
                        {% endif %}
                    </p>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function toggleTable(event) {
        const checkbox = event.target;
        const tableId = checkbox.dataset.id;
        fetch(`/home/toggle-table/${tableId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const card = checkbox.closest('.card');
                if (data.is_available) {
                    card.classList.remove('bg-red-50', 'border-red-200');
                    card.classList.add('bg-white');
                    card.querySelector('a').classList.remove('pointer-events-none', 'opacity-50');
                    card.querySelector('.text-sm').className = 'text-sm text-green-600';
                    card.querySelector('.text-sm').innerHTML = '<i class="fas fa-check-circle mr-1"></i>Disponible';
                } else {
                    card.classList.remove('bg-white');
                    card.classList.add('bg-red-50', 'border-red-200');
                    card.querySelector('a').classList.add('pointer-events-none', 'opacity-50');
                    card.querySelector('.text-sm').className = 'text-sm text-red-600';
                    card.querySelector('.text-sm').innerHTML = '<i class="fas fa-times-circle mr-1"></i>Ocupada';
                }
            } else {
                alert('Error al cambiar estado de la mesa');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cambiar estado de la mesa');
        });
    }
</script>
{% endblock %}
