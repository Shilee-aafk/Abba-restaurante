re {% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Menú para Mesa {{ table.number }}</h1>

  <form method="post" action="{% url 'logout' %}" class="d-inline mb-4">
    {% csrf_token %}
    <button type="submit" class="btn btn-secondary">Cerrar Sesión</button>
  </form>

  <h2>Productos</h2>
  <div class="row">
    {% for product in products %}
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ product.name }} <span class="text-muted">${{ product.price }}</span></h5>
          <div class="mb-2">
            <input type="number" id="qty-{{ product.id }}" class="form-control" value="1" min="1" />
          </div>
          <textarea id="notes-{{ product.id }}" class="form-control mb-2" placeholder="Notas"></textarea>
          <button class="btn btn-primary mt-auto btn-add" data-product-id="{{ product.id }}">Agregar</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <h2>Carrito</h2>
  <form method="post" action="{% url 'send_order' table.id %}">
    {% csrf_token %}
    <div id="cart-items" class="mb-3">
      <!-- Items will be dynamically added here -->
    </div>
    <textarea name="order_notes" id="order-notes" class="form-control mb-3" placeholder="Notas del pedido"></textarea>
    <button type="submit" class="btn btn-success">Enviar Pedido</button>
    <!-- Campos ocultos para enviar los items -->
    <div id="hidden-items"></div>
  </form>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const cartItems = {};

      function renderCart() {
        const cartContainer = document.getElementById('cart-items');
        cartContainer.innerHTML = '';
        for (const id in cartItems) {
          const item = cartItems[id];
          const div = document.createElement('div');
          div.className = 'mb-2';
          div.textContent = `${item.name} x ${item.quantity} - Notas: ${item.notes}`;
          cartContainer.appendChild(div);
        }
      }

      function updateHiddenInputs() {
        const hiddenItemsDiv = document.getElementById('hidden-items');
        hiddenItemsDiv.innerHTML = '';
        let index = 0;
        for (const id in cartItems) {
          const item = cartItems[id];
          // Crear inputs ocultos para cada propiedad
          const inputId = document.createElement('input');
          inputId.type = 'hidden';
          inputId.name = `item_id_${index}`;
          inputId.value = id;
          hiddenItemsDiv.appendChild(inputId);

          const inputQuantity = document.createElement('input');
          inputQuantity.type = 'hidden';
          inputQuantity.name = `quantity_${index}`;
          inputQuantity.value = item.quantity;
          hiddenItemsDiv.appendChild(inputQuantity);

          const inputNotes = document.createElement('input');
          inputNotes.type = 'hidden';
          inputNotes.name = `notes_${index}`;
          inputNotes.value = item.notes;
          hiddenItemsDiv.appendChild(inputNotes);

          index++;
        }
      }

      document.querySelectorAll('.btn-add').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.getAttribute('data-product-id');
          const qtyInput = document.getElementById('qty-' + productId);
          const notesInput = document.getElementById('notes-' + productId);
          const quantity = parseInt(qtyInput.value);
          const notes = notesInput.value.trim();
          const productName = button.closest('.card-body').querySelector('.card-title').childNodes[0].textContent.trim();

          if (quantity > 0) {
            // Si el producto ya existe, sumar cantidades
            if (cartItems[productId]) {
              cartItems[productId].quantity += quantity;
              // Concatenar notas si hay nuevas
              if (notes) {
                cartItems[productId].notes += ' | ' + notes;
              }
            } else {
              cartItems[productId] = { name: productName, quantity: quantity, notes: notes };
            }
            renderCart();
            updateHiddenInputs();
          }
        });
      });


    });
  </script>
{% endblock %}
