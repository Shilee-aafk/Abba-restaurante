{% extends "base.html" %}
{% block title %}Menú para Mesa {{ table.number }} - Restaurante ABBA{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Menú para Mesa {{ table.number }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {% for product in products %}
        <div class="card p-6">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">{{ product.name }}</h3>
                    <span class="text-lg font-bold text-blue-600">${{ product.price }}</span>
                </div>
                {% if product.description %}
                <p class="text-gray-600 mb-4 flex-grow">{{ product.description }}</p>
                {% endif %}
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" id="qty-{{ product.id }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="1" min="1" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                        <textarea id="notes-{{ product.id }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Notas especiales"></textarea>
                    </div>
                    <button class="btn-primary w-full py-2 px-4 rounded-md font-medium btn-add" data-product-id="{{ product.id }}">
                        <i class="fas fa-plus mr-2"></i>Agregar al Carrito
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Carrito de Compras</h2>
        <form method="post" action="{% url 'send_order' table.id %}">
            {% csrf_token %}
            <div id="cart-items" class="space-y-2 mb-4">
                <!-- Items will be dynamically added here -->
            </div>
            <div class="mb-4">
                <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-2">Notas del Pedido</label>
                <textarea name="order_notes" id="order-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Notas adicionales para el pedido"></textarea>
            </div>
            <button type="submit" class="btn-success w-full py-3 px-4 rounded-md font-medium">
                <i class="fas fa-paper-plane mr-2"></i>Enviar Pedido
            </button>
            <!-- Campos ocultos para enviar los items -->
            <div id="hidden-items"></div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartItems = {};

        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            cartContainer.innerHTML = '';
            for (const key in cartItems) {
                const item = cartItems[key];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-md';
                const displayName = item.notes ? `${item.name} (Notas: ${item.notes})` : item.name;
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${displayName}</span>
                        <span class="text-gray-600 ml-2">x ${item.quantity}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700" onclick="removeItem('${key}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                cartContainer.appendChild(div);
            }
        }

        function removeItem(key) {
            delete cartItems[key];
            renderCart();
            updateHiddenInputs();
        }

        function updateHiddenInputs() {
            const hiddenItemsDiv = document.getElementById('hidden-items');
            hiddenItemsDiv.innerHTML = '';
            let index = 0;
            for (const key in cartItems) {
                const item = cartItems[key];
                // Extraer productId de la key
                const productId = key.split('|')[0];
                // Crear inputs ocultos para cada propiedad
                const inputId = document.createElement('input');
                inputId.type = 'hidden';
                inputId.name = `item_id_${index}`;
                inputId.value = productId;
                hiddenItemsDiv.appendChild(inputId);

                const inputQuantity = document.createElement('input');
                inputQuantity.type = 'hidden';
                inputQuantity.name = `quantity_${index}`;
                inputQuantity.value = item.quantity;
                hiddenItemsDiv.appendChild(inputQuantity);

                const inputNotes = document.createElement('input');
                inputNotes.type = 'hidden';
                inputNotes.name = `notes_${index}`;
                inputNotes.value = item.notes;
                hiddenItemsDiv.appendChild(inputNotes);

                index++;
            }
        }

        document.querySelectorAll('.btn-add').forEach(button => {
            button.addEventListener('click', () => {
                const productId = button.getAttribute('data-product-id');
                const qtyInput = document.getElementById('qty-' + productId);
                const notesInput = document.getElementById('notes-' + productId);
                const quantity = parseInt(qtyInput.value);
                const notes = notesInput.value.trim();
                const productName = button.closest('.card').querySelector('h3').textContent.trim();

                if (quantity > 0) {
                    // Crear clave única basada en producto y notas
                    const key = notes ? `${productId}|${notes}` : productId;
                    // Si ya existe, sumar cantidad
                    if (cartItems[key]) {
                        cartItems[key].quantity += quantity;
                    } else {
                        cartItems[key] = { name: productName, quantity: quantity, notes: notes };
                    }
                    renderCart();
                    updateHiddenInputs();
                }
            });
        });
    });
</script>
{% endblock %}
